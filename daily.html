<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Rainfall Totals</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="light">
  <div id="site-header"></div>

  <main class="container">
    <section class="header-block">
      <h2>Daily Rainfall Totals</h2>
      <div class="meta">
        <div id="clock">--:--:--</div>
        <div id="lastUpdated">Aggregated from per-interval data</div>
      </div>
    </section>

    <section class="card chart-card">
      <div class="chart-title">Last 30 days (mm)</div>
      <canvas id="dailyRainChart"></canvas>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { injectHeader } from './partials/include.js?v=13';
    await injectHeader();

    // Clock
    const pad2 = n => String(n).padStart(2,'0');
    const clockFmt = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    setInterval(()=> (document.getElementById("clock").textContent = clockFmt(new Date())), 1000);

    // Supabase config
    const PROJECT_URL = "https://scbekobcwdxrfvdiofjp.supabase.co";
    const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjYmVrb2Jjd2R4cmZ2ZGlvZmpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MDg4ODgsImV4cCI6MjA3MDI4NDg4OH0.FTSxV5J-vPN59NCrplGRIEvk9NFZ3-0y8yya-YxKnjM";
    const DAILY_RESET_HOUR_LOCAL = 7;   // match device reset 07:00 WIB
    const HAS_INTERVAL_COLUMN = true;   // we send rainfall_mm_interval from ESP32

    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(PROJECT_URL, ANON_KEY);

    const css = (v,f)=>getComputedStyle(document.body).getPropertyValue(v).trim()||f;
    const gridColor = () => {
      const v = css('--muted','#6b7280');
      return v.startsWith('hsl') ? v.replace(')', ' / 0.22)') : (v + '22');
    };
    function showErrorBanner(msg){
      let b=document.getElementById('errBanner'); if(!b){b=document.createElement('div');b.id='errBanner';b.style.cssText='position:fixed;left:12px;right:12px;bottom:12px;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:10px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15);font:600 13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;z-index:9999;';document.body.appendChild(b);} b.textContent=msg; setTimeout(()=>{try{b.remove();}catch{}},8000);
    }

    let resolvedTable='weather_readings';
    async function resolveTable(selectCols){
      let r=await supabase.from('weather_readings').select(selectCols).limit(1);
      if(!r.error){resolvedTable='weather_readings';return;}
      r=await supabase.from('weather-readings').select(selectCols).limit(1);
      if(!r.error){resolvedTable='weather-readings';return;}
      showErrorBanner('Cannot read table. Check RLS & table name.');
    }

    const cols = HAS_INTERVAL_COLUMN
      ? "created_at, ts, rainfall_mm, rainfall_mm_interval"
      : "created_at, ts, rainfall_mm";
    await resolveTable(cols);

    const { data, error } = await supabase.from(resolvedTable).select(cols).order("created_at", { ascending: true });
    if (error) console.error(error);

    const dayTotals = new Map();   // key -> sum(intervals)
    const dayMaxCum = new Map();   // fallback if no interval
    function dayKeyWithReset(date){
      const d=new Date(date), shift=DAILY_RESET_HOUR_LOCAL*3600*1000;
      const s=new Date(d.getTime()-shift);
      const y=s.getFullYear(), m=String(s.getMonth()+1).padStart(2,'0'), dd=String(s.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    (data||[]).forEach(row=>{
      const ts=row.ts ?? row.created_at; if(!ts) return;
      const key=dayKeyWithReset(new Date(ts));
      if (HAS_INTERVAL_COLUMN && row.rainfall_mm_interval!=null){
        const v=Number(row.rainfall_mm_interval)||0;
        dayTotals.set(key,(dayTotals.get(key)||0)+v);
      } else {
        const cum=Number(row.rainfall_mm||0);
        dayMaxCum.set(key, Math.max(dayMaxCum.get(key)||0, cum));
      }
    });
    if (!HAS_INTERVAL_COLUMN) dayMaxCum.forEach((v,k)=>dayTotals.set(k,v));

    const labels=[], values=[];
    const today=new Date(); const cutoff=new Date(today); cutoff.setDate(cutoff.getDate()-30);
    [...dayTotals.entries()].sort(([a],[b])=>a.localeCompare(b)).forEach(([k,v])=>{
      const d=new Date(k+"T00:00:00"); if(d>=cutoff){labels.push(k); values.push(v);}
    });

    const ctx=document.getElementById("dailyRainChart").getContext("2d");
    const chart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:"Daily rainfall (mm)",data:values,backgroundColor:"rgba(56,189,248,0.6)"}]},options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:css('--text','#0f172a')}}},
      scales:{x:{ticks:{color:css('--muted','#6b7280')},grid:{color:gridColor()}},y:{beginAtZero:true,ticks:{color:css('--muted','#6b7280')},grid:{color:gridColor()}}}
    }});
  </script>
</body>
</html>
