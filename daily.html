<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Rainfall Totals</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="light">

  <!-- Shared header mount -->
  <div id="site-header"></div>

  <main class="container">
    <section class="header-block">
      <h2>Daily Rainfall Totals</h2>
      <div class="meta">
        <div id="clock">--:--:--</div>
        <div id="lastUpdated">Aggregated from 10-minute data</div>
      </div>
    </section>

    <section class="card chart-card">
      <div class="chart-title">Last 30 days (mm)</div>
      <canvas id="dailyRainChart"></canvas>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module" src="partials/include.js"></script>
  <script type="module">
    import { injectHeader } from './partials/include.js';
    await injectHeader();

    // Live clock
    (function startClock(){
      const el = document.getElementById("clock");
      const pad2 = n => String(n).padStart(2,'0');
      const formatClock = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
      setInterval(() => el.textContent = formatClock(new Date()), 1000);
    })();

    // Supabase read + chart
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient("https://YOUR_PROJECT.supabase.co", "YOUR_ANON_PUBLIC_KEY");

    // set true if your table has rainfall_mm_interval
    const HAS_INTERVAL_COLUMN = false;

    const css = (v,f)=>getComputedStyle(document.body).getPropertyValue(v).trim()||f;
    const grid = ()=> css('--muted','#6b7280')+'22';

    const cols = HAS_INTERVAL_COLUMN
      ? "created_at, rainfall_mm, rainfall_mm_interval"
      : "created_at, rainfall_mm";

    const { data, error } = await supabase
      .from("weather_readings")  // or "weather-readings"
      .select(cols)
      .order("created_at", { ascending: true });

    if (error) console.error(error);

    // Group by local date (simple: use max cumulative per day if interval missing)
    const dayTotals = new Map(); // key=YYYY-MM-DD, value=total mm
    const dayMaxCum = new Map();

    const toLocalDateKey = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    data?.forEach(row => {
      const ts = new Date(row.created_at);
      const key = toLocalDateKey(ts);

      if (HAS_INTERVAL_COLUMN && row.rainfall_mm_interval != null) {
        const v = Number(row.rainfall_mm_interval) || 0;
        dayTotals.set(key, (dayTotals.get(key) || 0) + v);
      } else {
        const cum = Number(row.rainfall_mm || 0);
        dayMaxCum.set(key, Math.max(dayMaxCum.get(key) || 0, cum));
      }
    });

    if (!HAS_INTERVAL_COLUMN) {
      dayMaxCum.forEach((maxCum, key) => dayTotals.set(key, maxCum));
    }

    // Keep last 30 days
    const today = new Date();
    const cutoff = new Date(today); cutoff.setDate(cutoff.getDate() - 30);
    const labels = [];
    const values = [];
    [...dayTotals.entries()].forEach(([key, val]) => {
      const d = new Date(key + "T00:00:00");
      if (d >= cutoff) { labels.push(key); values.push(val); }
    });

    const ctx = document.getElementById("dailyRainChart").getContext("2d");
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: "Daily rainfall (mm)",
          data: values,
          backgroundColor: "rgba(56,189,248,0.6)"
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: css('--text','#0f172a') } } },
        scales: {
          x: { ticks: { color: css('--muted','#6b7280') }, grid: { color: grid() } },
          y: { ticks: { color: css('--muted','#6b7280') }, grid: { color: grid() }, beginAtZero: true }
        }
      }
    });

    // Retint on theme change
    const mo = new MutationObserver(() => {
      chart.options.plugins.legend.labels.color = css('--text','#0f172a');
      chart.options.scales.x.ticks.color = css('--muted','#6b7280');
      chart.options.scales.x.grid.color = grid();
      chart.options.scales.y.ticks.color = css('--muted','#6b7280');
      chart.options.scales.y.grid.color = grid();
      chart.update('none');
    });
    mo.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  </script>
</body>
</html>
